## This docker-compose config file is used to define test variations of the
## images in this repository.

version: "3.7"

services:
  api_test:
    image: "stevenxie/api-tester:latest"
    build:
      context: ..
      dockerfile: ./build/tester.Dockerfile
      cache_from:
        - stevenxie/api-tester:latest
        - golang:1
    container_name: api_test
    working_dir: /workspace
    volumes:
      - type: bind
        source: ..
        target: /workspace

  varnish_test:
    image: "cooptilleuls/varnish:6.0.0-alpine"
    entrypoint: sh
    command:
      - -c
      - |
        TMPFILE="$$(mktemp)" && \
        trap 'rm -f $$TMPFILE' 0 && \
        if ! varnishd -Cf "$$CONFIGFILE" 2> $$TMPFILE 1> /dev/null; then \
          cat $$TMPFILE && exit 1;
        fi
    environment:
      CONFIGFILE: /usr/local/etc/varnish/default.vcl
    container_name: varnish_test
    volumes:
      - type: bind
        source: ./varnish.vcl
        target: /usr/local/etc/varnish/default.vcl
        read_only: true
